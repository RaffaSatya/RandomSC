local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
   Name = "Uma Racing Script",
   Icon = 0,
   LoadingTitle = "Loading...",
   LoadingSubtitle = "by Zeader",
   ShowText = "Rayfield",
   Theme = "Default",

   ToggleUIKeybind = "K",

   DisableRayfieldPrompts = false,
   DisableBuildWarnings = false,

   ConfigurationSaving = {
      Enabled = false,
      FolderName = nil,
      FileName = "Big Hub"
   },

   Discord = {
      Enabled = false,
      Invite = "noinvitelink",
      RememberJoins = true
   },

   KeySystem = true,
   KeySettings = {
      Title = "Uma Racing Script",
      Subtitle = "Key System",
      Note = "Click the link to get the key",
      FileName = "Zead",
      SaveKey = true,
      GrabKeyFromSite = true,
      Key = {"https://pastebin.com/raw/QF6Z5Arx"}
   }
})

-- Variables
local player = game.Players.LocalPlayer
local currentCheckpoint = 0 -- Track which checkpoint player has passed

-- Available characters
local characters = {
   "Oguri Cap",
   "Tamamo Cross",
   "Rice Shower",
   "Silence Suzuka"
}

-- Checkpoint parts configuration
local checkpointParts = {
   {name = "Checkpoint 1 (Start)", part = workspace:WaitForChild("StartLine")},
   {name = "Checkpoint 2", part = workspace.Checkpoint:WaitForChild("Checkpoint2")},
   {name = "Checkpoint 3", part = workspace.Checkpoint:WaitForChild("Checkpoint3")},
   {name = "Checkpoint 4", part = workspace.Checkpoint:WaitForChild("Checkpoint4")},
   {name = "Checkpoint 5", part = workspace.Checkpoint:WaitForChild("Checkpoint5")},
   {name = "Checkpoint 6", part = workspace.Checkpoint:WaitForChild("Checkpoint6")},
   {name = "Checkpoint 7 (Finish)", part = workspace:WaitForChild("FinishLine")},
   {name = "Checkpoint 8 (Loop)", part = workspace.Checkpoint:WaitForChild("Checkpoint1")}
}

-- Function to get player's stamina info
local function getPlayerStaminaInfo()
   local playerFolder = workspace.Players:FindFirstChild(player.Name)
   if playerFolder and playerFolder:FindFirstChild("Info") then
      return playerFolder.Info
   end
   return nil
end

-- Function to auto win race
local function autoWin()
   if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
      Rayfield:Notify({
         Title = "Error",
         Content = "Character not found!",
         Duration = 3,
         Image = 4483362458,
      })
      return
   end
   
   Rayfield:Notify({
      Title = "Auto Win Started! üèÜ",
      Content = "Teleporting through checkpoints...",
      Duration = 2,
      Image = 4483362458,
   })
   
   local hrp = player.Character.HumanoidRootPart
   
   hrp.CFrame = CFrame.new(-1442, 30, 1949)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1629, 30, 964)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1933, 30, -313)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1656, 30, -1344)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-738, 30, -1114)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-687, 30, -290)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-693, 30, 561)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-881, 30, 1065)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1629, 30, 964)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1933, 30, -313)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1656, 30, -1344)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-738, 30, -1114)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-687, 30, -290)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-693, 30, 561)
   
   Rayfield:Notify({
      Title = "Race Complete! üèÜ",
      Content = "Auto Win finished!",
      Duration = 3,
      Image = 4483362458,
   })
end

-- Function to change character (stealthy method)
local function changeCharacter(characterName)
   -- Add a small delay to avoid detection
   task.wait(0.1)
   
   -- Ensure we have a string, not a table
   if type(characterName) == "table" then
      characterName = characterName[1] or tostring(characterName)
   end
   
   local success, err = pcall(function()
      if player:FindFirstChild("CurrentCharacter") then
         -- Change value directly like Dex does
         player.CurrentCharacter.Value = tostring(characterName)
      else
         error("CurrentCharacter not found")
      end
   end)
   
   if success then
      Rayfield:Notify({
         Title = "Character Changed! ‚ú®",
         Content = "Selected: " .. tostring(characterName),
         Duration = 2,
         Image = 4483362458,
      })
   else
      Rayfield:Notify({
         Title = "Change Failed ‚ùå",
         Content = tostring(err),
         Duration = 3,
         Image = 4483362458,
      })
      print("Error changing character:", err)
      print("Character name type:", type(characterName))
      print("Character name value:", characterName)
   end
end

-- Function to setup touch detection for checkpoints
local function setupCheckpointDetection()
   for i, checkpoint in ipairs(checkpointParts) do
      if checkpoint.part then
         checkpoint.part.Touched:Connect(function(hit)
            if hit.Parent == player.Character and hit.Name == "HumanoidRootPart" then
               -- Update current checkpoint if this is the next one in sequence
               if i == currentCheckpoint + 1 then
                  currentCheckpoint = i
                  
                  -- Notify player
                  Rayfield:Notify({
                     Title = "Checkpoint Passed! ‚úÖ",
                     Content = checkpoint.name .. " completed",
                     Duration = 2,
                     Image = 4483362458,
                  })
               end
            end
         end)
      end
   end
end

-- Function to get the next checkpoint to teleport to
local function getNextCheckpoint()
   -- If no checkpoint passed yet, go to checkpoint 1
   if currentCheckpoint == 0 then
      return 1
   end
   
   -- If passed checkpoint 8 (finish), loop back to checkpoint 2
   if currentCheckpoint >= #checkpointParts then
      currentCheckpoint = 1 -- Reset to 1 so next will be 2
      return 2
   end
   
   -- Otherwise, go to the next checkpoint
   return currentCheckpoint + 1
end

-- Function to teleport to specific checkpoint
local function teleportToCheckpoint(checkpointNum)
   if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
      Rayfield:Notify({
         Title = "Error",
         Content = "Character not found!",
         Duration = 3,
         Image = 4483362458,
      })
      return
   end
   
   if checkpointNum < 1 or checkpointNum > #checkpointParts then
      Rayfield:Notify({
         Title = "Error",
         Content = "Invalid checkpoint number!",
         Duration = 3,
         Image = 4483362458,
      })
      return
   end
   
   local checkpoint = checkpointParts[checkpointNum]
   
   if checkpoint.part then
      -- Teleport to the checkpoint part position (slightly above it)
      local partPos = checkpoint.part.Position
      player.Character.HumanoidRootPart.CFrame = CFrame.new(partPos.X, partPos.Y + 5, partPos.Z)
      
      Rayfield:Notify({
         Title = "Teleported! üöÄ",
         Content = "Moved to " .. checkpoint.name,
         Duration = 2,
         Image = 4483362458,
      })
   else
      Rayfield:Notify({
         Title = "Error",
         Content = "Checkpoint part not found!",
         Duration = 3,
         Image = 4483362458,
      })
   end
end

-- Setup checkpoint detection on character spawn
local function onCharacterAdded(character)
   setupCheckpointDetection()
end

if player.Character then
   onCharacterAdded(player.Character)
end
player.CharacterAdded:Connect(onCharacterAdded)

-- Create Tabs
local MainTab = Window:CreateTab("Main", nil)
local CharacterTab = Window:CreateTab("Character", nil)
local CheckpointTab = Window:CreateTab("Checkpoints", nil)
local SettingsTab = Window:CreateTab("Settings", nil)

-- Main Tab
local Section = MainTab:CreateSection("Quick Actions")

local AutoWinButton = MainTab:CreateButton({
   Name = "üèÜ Auto Win Race",
   Callback = function()
      autoWin()
   end,
})

local NextCheckpointButton = MainTab:CreateButton({
   Name = "üèÅ Go to Next Checkpoint",
   Callback = function()
      local next = getNextCheckpoint()
      
      if currentCheckpoint == 0 then
         Rayfield:Notify({
            Title = "Starting Race! üèÅ",
            Content = "Going to Checkpoint 1...",
            Duration = 2,
            Image = 4483362458,
         })
      elseif currentCheckpoint >= #checkpointParts then
         Rayfield:Notify({
            Title = "Race Complete! üèÜ",
            Content = "Looping to Checkpoint 2...",
            Duration = 2,
            Image = 4483362458,
         })
      else
         Rayfield:Notify({
            Title = "Progress Detected ‚úÖ",
            Content = "Passed CP" .. currentCheckpoint .. " ‚Üí Going to CP" .. next,
            Duration = 2,
            Image = 4483362458,
         })
      end
      
      teleportToCheckpoint(next)
   end,
})

local CheckProgressButton = MainTab:CreateButton({
   Name = "üìç Check Current Progress",
   Callback = function()
      if currentCheckpoint == 0 then
         Rayfield:Notify({
            Title = "No Progress Yet",
            Content = "You haven't passed any checkpoints",
            Duration = 3,
            Image = 4483362458,
         })
      else
         Rayfield:Notify({
            Title = "Current Progress",
            Content = "Last passed: " .. checkpointParts[currentCheckpoint].name,
            Duration = 3,
            Image = 4483362458,
         })
      end
   end,
})

-- Character Tab
local CharacterSection = CharacterTab:CreateSection("Character Selection")

local CharacterDropdown = CharacterTab:CreateDropdown({
   Name = "üé≠ Select Character",
   Options = characters,
   CurrentOption = {"Oguri Cap"},
   MultipleOptions = false,
   Flag = "CharacterSelector",
   Callback = function(Option)
      -- Convert table to string if needed
      local characterName = Option
      if type(Option) == "table" then
         characterName = Option[1] or Option
      end
      changeCharacter(characterName)
   end,
})

local CurrentCharacterButton = CharacterTab:CreateButton({
   Name = "üìã Check Current Character",
   Callback = function()
      if player:FindFirstChild("CurrentCharacter") then
         local current = player.CurrentCharacter.Value
         Rayfield:Notify({
            Title = "Current Character üé≠",
            Content = "You are: " .. tostring(current),
            Duration = 3,
            Image = 4483362458,
         })
      else
         Rayfield:Notify({
            Title = "Error",
            Content = "CurrentCharacter not found!",
            Duration = 3,
            Image = 4483362458,
         })
      end
   end,
})

-- Checkpoint Tab
local CPSection = CheckpointTab:CreateSection("Manual Checkpoint Selection")

for i = 1, #checkpointParts do
   CheckpointTab:CreateButton({
      Name = checkpointParts[i].name,
      Callback = function()
         teleportToCheckpoint(i)
      end,
   })
end

-- Settings Tab
local SettingsSection = SettingsTab:CreateSection("Progress Settings")

local ResetProgressButton = SettingsTab:CreateButton({
   Name = "üîÑ Reset Checkpoint Progress",
   Callback = function()
      currentCheckpoint = 0
      Rayfield:Notify({
         Title = "Progress Reset",
         Content = "Checkpoint progress has been reset",
         Duration = 2,
         Image = 4483362458,
      })
   end,
})

local InfoSection = SettingsTab:CreateSection("Information")

local InfoLabel = SettingsTab:CreateLabel("This script tracks your race progress automatically.")
local InfoLabel2 = SettingsTab:CreateLabel("Touch each checkpoint part to progress!")

-- Startup notification
Rayfield:Notify({
   Title = "Script Loaded! ‚úÖ",
   Content = "Uma Racing Script by Zead",
   Duration = 3,
   Image = 4483362458,
})

-- Initial setup
setupCheckpointDetection()
