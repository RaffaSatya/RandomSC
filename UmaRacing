local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
   Name = "Uma Racing Script",
   Icon = 0,
   LoadingTitle = "Loading The Script",
   LoadingSubtitle = "by Zead",
   ShowText = "Rayfield",
   Theme = "Default",

   ToggleUIKeybind = "K",

   DisableRayfieldPrompts = false,
   DisableBuildWarnings = false,

   ConfigurationSaving = {
      Enabled = false,
      FolderName = nil,
      FileName = "Big Hub"
   },

   Discord = {
      Enabled = false,
      Invite = "noinvitelink",
      RememberJoins = true
   },

   KeySystem = false,
   KeySettings = {
      Title = "Untitled",
      Subtitle = "Key System",
      Note = "No method of obtaining the key is provided",
      FileName = "Key",
      SaveKey = true,
      GrabKeyFromSite = false,
      Key = {"Hello"}
   }
})

local player = game.Players.LocalPlayer
local currentCheckpoint = 0 -- Track which checkpoint player has passed
local infiniteStaminaEnabled = false
local originalNamecall = nil

local characters = {
   "Oguri Cap",
   "Tamamo Cross",
   "Rice Shower",
   "Silence Suzuka"
}

local checkpointParts = {
   {name = "Checkpoint 1 (Start)", part = workspace:WaitForChild("StartLine")},
   {name = "Checkpoint 2", part = workspace.Checkpoint:WaitForChild("Checkpoint2")},
   {name = "Checkpoint 3", part = workspace.Checkpoint:WaitForChild("Checkpoint3")},
   {name = "Checkpoint 4", part = workspace.Checkpoint:WaitForChild("Checkpoint4")},
   {name = "Checkpoint 5", part = workspace.Checkpoint:WaitForChild("Checkpoint5")},
   {name = "Checkpoint 6", part = workspace.Checkpoint:WaitForChild("Checkpoint6")},
   {name = "Checkpoint 7 (Finish)", part = workspace:WaitForChild("FinishLine")},
   {name = "Checkpoint 8 (Loop)", part = workspace.Checkpoint:WaitForChild("Checkpoint1")}
}

local function getPlayerStaminaInfo()
   local playerFolder = workspace.Players:FindFirstChild(player.Name)
   if playerFolder and playerFolder:FindFirstChild("Info") then
      return playerFolder.Info
   end
   return nil
end

local function toggleInfiniteStamina(enabled)
   infiniteStaminaEnabled = enabled
   
   if enabled then
      originalNamecall = hookmetamethod(game, "__namecall", function(self, ...)
         local method = getnamecallmethod()
         
         if method == "FireServer" and self.Name == "RequestSprintAction" then
            return -- Block it (silent, no notification)
         end
         
         return originalNamecall(self, ...)
      end)
   else
      if originalNamecall then
         hookmetamethod(game, "__namecall", originalNamecall)
      end
   end
end

local function autoWin()
   if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
      return
   end
   
   local hrp = player.Character.HumanoidRootPart
   
   hrp.CFrame = CFrame.new(-1442, 30, 1949)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1629, 30, 964)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1933, 30, -313)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1656, 30, -1344)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-738, 30, -1114)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-687, 30, -290)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-693, 30, 561)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-881, 30, 1065)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1629, 30, 964)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1933, 30, -313)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1656, 30, -1344)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-738, 30, -1114)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-687, 30, -290)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-693, 30, 561)
end

local function changeCharacter(characterName)
   task.wait(0.1)
   
   if type(characterName) == "table" then
      characterName = characterName[1] or tostring(characterName)
   end
   
   local success, err = pcall(function()
      if player:FindFirstChild("CurrentCharacter") then
         player.CurrentCharacter.Value = tostring(characterName)
      else
         error("CurrentCharacter not found")
      end
   end)
   
   if success then
      Rayfield:Notify({
         Title = "Character Changed! ‚ú®",
         Content = "Selected: " .. tostring(characterName),
         Duration = 2,
         Image = 4483362458,
      })
   else
      Rayfield:Notify({
         Title = "Change Failed ‚ùå",
         Content = tostring(err),
         Duration = 3,
         Image = 4483362458,
      })
      print("Error changing character:", err)
      print("Character name type:", type(characterName))
      print("Character name value:", characterName)
   end
end

local function setupCheckpointDetection()
   local spawnLocation = workspace:FindFirstChild("SpawnLocation")
   if spawnLocation then
      spawnLocation.Touched:Connect(function(hit)
         if hit.Parent == player.Character and hit.Name == "HumanoidRootPart" then
            currentCheckpoint = 0
            Rayfield:Notify({
               Title = "Checkpoint Reset üîÑ",
               Content = "Progress has been reset",
               Duration = 2,
               Image = 4483362458,
            })
         end
      end)
   end
   
   for i, checkpoint in ipairs(checkpointParts) do
      if checkpoint.part then
         checkpoint.part.Touched:Connect(function(hit)
            if hit.Parent == player.Character and hit.Name == "HumanoidRootPart" then
               if i == 8 then
                  currentCheckpoint = 1
               elseif i == currentCheckpoint + 1 then
                  currentCheckpoint = i
                  Rayfield:Notify({
                     Title = "Checkpoint Passed! ‚úÖ",
                     Content = checkpoint.name .. " completed",
                     Duration = 2,
                     Image = 4483362458,
                  })
               elseif currentCheckpoint == 1 and i >= 2 and i <= 7 then
                  currentCheckpoint = i
                  Rayfield:Notify({
                     Title = "Checkpoint Passed! ‚úÖ",
                     Content = checkpoint.name .. " completed (Lap 2+)",
                     Duration = 2,
                     Image = 4483362458,
                  })
               end
            end
         end)
      end
   end
end

local function getNextCheckpoint()
   if currentCheckpoint == 0 then
      return 1
   end
   
   if currentCheckpoint >= #checkpointParts then
      currentCheckpoint = 1
      return 2
   end
   
   return currentCheckpoint + 1
end

local function teleportToCheckpoint(checkpointNum)
   if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
      return
   end
   
   if checkpointNum < 1 or checkpointNum > #checkpointParts then
      return
   end
   
   local checkpoint = checkpointParts[checkpointNum]
   
   if checkpoint.part then
      local partPos = checkpoint.part.Position
      player.Character.HumanoidRootPart.CFrame = CFrame.new(partPos.X, partPos.Y + 5, partPos.Z)
   end
end

local function onCharacterAdded(character)
   setupCheckpointDetection()
end

if player.Character then
   onCharacterAdded(player.Character)
end
player.CharacterAdded:Connect(onCharacterAdded)

local MainTab = Window:CreateTab("Main", nil)
local CharacterTab = Window:CreateTab("Character", nil)
local CheckpointTab = Window:CreateTab("Checkpoints", nil)
local PowerupsTab = Window:CreateTab("Powerups", nil)
local SettingsTab = Window:CreateTab("Settings", nil)

local Section = MainTab:CreateSection("Quick Actions")

local AutoWinButton = MainTab:CreateButton({
   Name = "üèÜ Auto Win Race",
   Callback = function()
      autoWin()
   end,
})

local NextCheckpointButton = MainTab:CreateButton({
   Name = "üèÅ Go to Next Checkpoint",
   Callback = function()
      local next = getNextCheckpoint()
      teleportToCheckpoint(next)
   end,
})

local CheckProgressButton = MainTab:CreateButton({
   Name = "üìç Check Current Progress",
   Callback = function()
      if currentCheckpoint == 0 then
         Rayfield:Notify({
            Title = "No Progress Yet",
            Content = "You haven't passed any checkpoints",
            Duration = 2,
            Image = 4483362458,
         })
      else
         Rayfield:Notify({
            Title = "Current Progress",
            Content = "Last passed: " .. checkpointParts[currentCheckpoint].name,
            Duration = 2,
            Image = 4483362458,
         })
      end
   end,
})

local CharacterSection = CharacterTab:CreateSection("Character Selection")

local CharacterDropdown = CharacterTab:CreateDropdown({
   Name = "üé≠ Select Character",
   Options = characters,
   CurrentOption = {"nil"},
   MultipleOptions = false,
   Flag = "CharacterSelector",
   Callback = function(Option)
      local characterName = Option
      if type(Option) == "table" then
         characterName = Option[1] or Option
      end
      changeCharacter(characterName)
   end,
})

local CurrentCharacterButton = CharacterTab:CreateButton({
   Name = "üìã Check Current Character",
   Callback = function()
      if player:FindFirstChild("CurrentCharacter") then
         local current = player.CurrentCharacter.Value
         Rayfield:Notify({
            Title = "Current Character üé≠",
            Content = "You are: " .. tostring(current),
            Duration = 3,
            Image = 4483362458,
         })
      else
         Rayfield:Notify({
            Title = "Error",
            Content = "CurrentCharacter not found!",
            Duration = 3,
            Image = 4483362458,
         })
      end
   end,
})

local CPSection = CheckpointTab:CreateSection("Manual Checkpoint Selection")

for i = 1, #checkpointParts do
   CheckpointTab:CreateButton({
      Name = checkpointParts[i].name,
      Callback = function()
         teleportToCheckpoint(i)
      end,
   })
end

local PowerupsSection = PowerupsTab:CreateSection("Stamina")

local InfiniteStaminaToggle = PowerupsTab:CreateToggle({
   Name = "Infinite Stamina",
   CurrentValue = false,
   Flag = "InfiniteStamina",
   Callback = function(Value)
      toggleInfiniteStamina(Value)
   end,
})

local StaminaLabel = PowerupsTab:CreateLabel("Becarefull")

local SettingsSection = SettingsTab:CreateSection("Progress Settings")

local ResetProgressButton = SettingsTab:CreateButton({
   Name = "üîÑ Reset Checkpoint Progress",
   Callback = function()
      currentCheckpoint = 0
      Rayfield:Notify({
         Title = "Progress Reset",
         Content = "Checkpoint progress has been reset",
         Duration = 2,
         Image = 4483362458,
      })
   end,
})

local InfoSection = SettingsTab:CreateSection("Information")

local InfoLabel = SettingsTab:CreateLabel("This script tracks your race progress automatically.")
local InfoLabel2 = SettingsTab:CreateLabel("Enjoy I guess")

Rayfield:Notify({
   Title = "Script Loaded! ‚úÖ",
   Content = "Uma Racing Script by Zead",
   Duration = 3,
   Image = 4483362458,
})

setupCheckpointDetection()
