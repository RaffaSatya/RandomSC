local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
   Name = "Uma Racing Script | By @Zeader",
   Icon = 0,
   LoadingTitle = "Loading...",
   LoadingSubtitle = "by Zeader",
   ShowText = "Rayfield",
   Theme = "Default",

   ToggleUIKeybind = "K",

   DisableRayfieldPrompts = false,
   DisableBuildWarnings = false,

   ConfigurationSaving = {
      Enabled = false,
      FolderName = nil,
      FileName = "Big Hub"
   },

   Discord = {
      Enabled = false,
      Invite = "noinvitelink",
      RememberJoins = true
   },

   KeySystem = true,
   KeySettings = {
      Title = "Key System",
      Subtitle = "Insert the key",
      Note = "https://discord.gg/ZwJZqscJ",
      FileName = "Zead",
      SaveKey = true,
      GrabKeyFromSite = true,
      Key = {"https://pastebin.com/raw/QF6Z5Arx"}
   }
})

-- Variables
local player = game.Players.LocalPlayer
local currentCheckpoint = 0 -- Track which checkpoint player has passed
local infiniteStaminaEnabled = false
local originalNamecall = nil

-- Available characters
local characters = {
   "Oguri Cap",
   "Tamamo Cross",
   "Rice Shower",
   "Silence Suzuka"
}

-- Checkpoint parts configuration
local checkpointParts = {
   {name = "Checkpoint 1 (Start)", part = workspace:WaitForChild("StartLine")},
   {name = "Checkpoint 2", part = workspace.Checkpoint:WaitForChild("Checkpoint2")},
   {name = "Checkpoint 3", part = workspace.Checkpoint:WaitForChild("Checkpoint3")},
   {name = "Checkpoint 4", part = workspace.Checkpoint:WaitForChild("Checkpoint4")},
   {name = "Checkpoint 5", part = workspace.Checkpoint:WaitForChild("Checkpoint5")},
   {name = "Checkpoint 6", part = workspace.Checkpoint:WaitForChild("Checkpoint6")},
   {name = "Checkpoint 7 (Finish)", part = workspace:WaitForChild("FinishLine")},
   {name = "Checkpoint 8 (Loop)", part = workspace.Checkpoint:WaitForChild("Checkpoint1")}
}

-- Function to get player's stamina info
local function getPlayerStaminaInfo()
   local playerFolder = workspace.Players:FindFirstChild(player.Name)
   if playerFolder and playerFolder:FindFirstChild("Info") then
      return playerFolder.Info
   end
   return nil
end

-- Function to toggle infinite stamina by blocking remote
local function toggleInfiniteStamina(enabled)
   infiniteStaminaEnabled = enabled
   
   if enabled then
      -- Hook the namecall metamethod to block RequestSprintAction
      originalNamecall = hookmetamethod(game, "__namecall", function(self, ...)
         local method = getnamecallmethod()
         
         -- Block RequestSprintAction remote to prevent stamina drain
         if method == "FireServer" and self.Name == "RequestSprintAction" then
            return -- Block it (silent, no notification)
         end
         
         return originalNamecall(self, ...)
      end)
   else
      -- Restore original namecall
      if originalNamecall then
         hookmetamethod(game, "__namecall", originalNamecall)
      end
   end
end

-- Function to auto win race
local function autoWin()
   if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
      return
   end
   
   local hrp = player.Character.HumanoidRootPart
   
   hrp.CFrame = CFrame.new(-1442, 30, 1949)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1629, 30, 964)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1933, 30, -313)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1656, 30, -1344)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-738, 30, -1114)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-687, 30, -290)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-693, 30, 561)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-881, 30, 1065)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1629, 30, 964)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1933, 30, -313)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-1656, 30, -1344)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-738, 30, -1114)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-687, 30, -290)
   task.wait(0.2)
   hrp.CFrame = CFrame.new(-693, 30, 561)
end

-- Function to change character (stealthy method)
local function changeCharacter(characterName)
   -- Add a small delay to avoid detection
   task.wait(0.1)
   
   -- Ensure we have a string, not a table
   if type(characterName) == "table" then
      characterName = characterName[1] or tostring(characterName)
   end
   
   local success, err = pcall(function()
      if player:FindFirstChild("CurrentCharacter") then
         -- Change value directly like Dex does
         player.CurrentCharacter.Value = tostring(characterName)
      else
         error("CurrentCharacter not found")
      end
   end)
   
   if success then
      Rayfield:Notify({
         Title = "Character Changed! ‚ú®",
         Content = "Selected: " .. tostring(characterName),
         Duration = 2,
         Image = 4483362458,
      })
   else
      Rayfield:Notify({
         Title = "Change Failed ‚ùå",
         Content = tostring(err),
         Duration = 3,
         Image = 4483362458,
      })
      print("Error changing character:", err)
      print("Character name type:", type(characterName))
      print("Character name value:", characterName)
   end
end

-- Function to setup touch detection for checkpoints
local function setupCheckpointDetection()
   -- Setup SpawnLocation touch to reset checkpoint
   local spawnLocation = workspace:FindFirstChild("SpawnLocation")
   if spawnLocation then
      spawnLocation.Touched:Connect(function(hit)
         if hit.Parent == player.Character and hit.Name == "HumanoidRootPart" then
            currentCheckpoint = 0
            Rayfield:Notify({
               Title = "Checkpoint Reset üîÑ",
               Content = "Progress has been reset",
               Duration = 2,
               Image = 4483362458,
            })
         end
      end)
   end
   
   -- Setup checkpoint parts detection
   for i, checkpoint in ipairs(checkpointParts) do
      if checkpoint.part then
         checkpoint.part.Touched:Connect(function(hit)
            if hit.Parent == player.Character and hit.Name == "HumanoidRootPart" then
               -- Special handling for checkpoint 8 (loop point)
               if i == 8 then
                  -- After passing checkpoint 8, reset to checkpoint 1 to continue tracking
                  currentCheckpoint = 1
                  Rayfield:Notify({
                     Title = "Lap Complete! üèÜ",
                     Content = "Starting next lap...",
                     Duration = 2,
                     Image = 4483362458,
                  })
               -- Normal checkpoint progression (1‚Üí2‚Üí3‚Üí4‚Üí5‚Üí6‚Üí7‚Üí8)
               elseif i == currentCheckpoint + 1 then
                  currentCheckpoint = i
                  Rayfield:Notify({
                     Title = "Checkpoint Passed! ‚úÖ",
                     Content = checkpoint.name .. " completed",
                     Duration = 2,
                     Image = 4483362458,
                  })
               -- Handle case where player is on lap 2+ and passes checkpoint 2-7
               elseif currentCheckpoint == 1 and i >= 2 and i <= 7 then
                  currentCheckpoint = i
                  Rayfield:Notify({
                     Title = "Checkpoint Passed! ‚úÖ",
                     Content = checkpoint.name .. " completed (Lap 2+)",
                     Duration = 2,
                     Image = 4483362458,
                  })
               end
            end
         end)
      end
   end
end

-- Function to get the next checkpoint to teleport to
local function getNextCheckpoint()
   -- If no checkpoint passed yet, go to checkpoint 1
   if currentCheckpoint == 0 then
      return 1
   end
   
   -- If passed checkpoint 8 (finish), loop back to checkpoint 2
   if currentCheckpoint >= #checkpointParts then
      currentCheckpoint = 1 -- Reset to 1 so next will be 2
      return 2
   end
   
   -- Otherwise, go to the next checkpoint
   return currentCheckpoint + 1
end

-- Function to teleport to specific checkpoint
local function teleportToCheckpoint(checkpointNum)
   if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
      return
   end
   
   if checkpointNum < 1 or checkpointNum > #checkpointParts then
      return
   end
   
   local checkpoint = checkpointParts[checkpointNum]
   
   if checkpoint.part then
      -- Teleport to the checkpoint part position (slightly above it)
      local partPos = checkpoint.part.Position
      player.Character.HumanoidRootPart.CFrame = CFrame.new(partPos.X, partPos.Y + 5, partPos.Z)
   end
end

-- Setup checkpoint detection on character spawn
local function onCharacterAdded(character)
   setupCheckpointDetection()
end

if player.Character then
   onCharacterAdded(player.Character)
end
player.CharacterAdded:Connect(onCharacterAdded)

-- Create Tabs
local MainTab = Window:CreateTab("Main", nil)
local CharacterTab = Window:CreateTab("Character", nil)
local CheckpointTab = Window:CreateTab("Checkpoints", nil)
local PowerupsTab = Window:CreateTab("Powerups", nil)
local SettingsTab = Window:CreateTab("Settings", nil)

-- Main Tab
local Section = MainTab:CreateSection("Quick Actions")

local AutoWinButton = MainTab:CreateButton({
   Name = "üèÜ Auto Win Race",
   Callback = function()
      autoWin()
   end,
})

local NextCheckpointButton = MainTab:CreateButton({
   Name = "üèÅ Go to Next Checkpoint",
   Callback = function()
      local next = getNextCheckpoint()
      teleportToCheckpoint(next)
   end,
})

local CheckProgressButton = MainTab:CreateButton({
   Name = "üìç Check Current Progress",
   Callback = function()
      if currentCheckpoint == 0 then
         Rayfield:Notify({
            Title = "No Progress Yet",
            Content = "You haven't passed any checkpoints",
            Duration = 3,
            Image = 4483362458,
         })
      else
         Rayfield:Notify({
            Title = "Current Progress",
            Content = "Last passed: " .. checkpointParts[currentCheckpoint].name,
            Duration = 3,
            Image = 4483362458,
         })
      end
   end,
})

-- Character Tab
local CharacterSection = CharacterTab:CreateSection("Character Selection")

local CharacterDropdown = CharacterTab:CreateDropdown({
   Name = "üé≠ Select Character",
   Options = characters,
   CurrentOption = {"Oguri Cap"},
   MultipleOptions = false,
   Flag = "CharacterSelector",
   Callback = function(Option)
      -- Convert table to string if needed
      local characterName = Option
      if type(Option) == "table" then
         characterName = Option[1] or Option
      end
      changeCharacter(characterName)
   end,
})

local CurrentCharacterButton = CharacterTab:CreateButton({
   Name = "üìã Check Current Character",
   Callback = function()
      if player:FindFirstChild("CurrentCharacter") then
         local current = player.CurrentCharacter.Value
         Rayfield:Notify({
            Title = "Current Character üé≠",
            Content = "You are: " .. tostring(current),
            Duration = 3,
            Image = 4483362458,
         })
      else
         Rayfield:Notify({
            Title = "Error",
            Content = "CurrentCharacter not found!",
            Duration = 3,
            Image = 4483362458,
         })
      end
   end,
})

-- Checkpoint Tab
local CPSection = CheckpointTab:CreateSection("Manual Checkpoint Selection")

for i = 1, #checkpointParts do
   CheckpointTab:CreateButton({
      Name = checkpointParts[i].name,
      Callback = function()
         teleportToCheckpoint(i)
      end,
   })
end

-- Powerups Tab
local PowerupsSection = PowerupsTab:CreateSection("Stamina")

local InfiniteStaminaToggle = PowerupsTab:CreateToggle({
   Name = "‚ö° Infinite Stamina",
   CurrentValue = false,
   Flag = "InfiniteStamina",
   Callback = function(Value)
      toggleInfiniteStamina(Value)
   end,
})

local StaminaLabel = PowerupsTab:CreateLabel("Blocks stamina drain by preventing sprint requests")

-- Settings Tab
local SettingsSection = SettingsTab:CreateSection("Progress Settings")

local ResetProgressButton = SettingsTab:CreateButton({
   Name = "üîÑ Reset Checkpoint Progress",
   Callback = function()
      currentCheckpoint = 0
      Rayfield:Notify({
         Title = "Progress Reset",
         Content = "Checkpoint progress has been reset",
         Duration = 2,
         Image = 4483362458,
      })
   end,
})

local InfoSection = SettingsTab:CreateSection("Information")

local InfoLabel = SettingsTab:CreateLabel("This script tracks your race progress automatically.")
local InfoLabel2 = SettingsTab:CreateLabel("Touch each checkpoint part to progress!")

-- Startup notification
Rayfield:Notify({
   Title = "Script Loaded! ‚úÖ",
   Content = "Uma Racing Script by Zead",
   Duration = 3,
   Image = 4483362458,
})

-- Initial setup
setupCheckpointDetection()
